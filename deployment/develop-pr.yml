variables:  
  azureSubscription: 'Playground'  
  environment: develop  
  resourceGroup: 'playground'
  appName: 'standa-playground'  
  destinationAppName: 'pipeline-cloned-app-$(System.PullRequest.PullRequestNumber)'
  slot: 'test'
  productionSlot: 'production'
  stagingUrl: 'https://standa-playground-test.azurewebsites.net'
  url: 'https://standa-playground.azurewebsites.net'
  utilsArtifact: 'DeployUtils'
  pipelinesDir: $(Build.SourcesDirectory)
  webRequestAttempts: 5
  webRequestDelayInSeconds: 15
  location: 'West Europe'
  appServicePlan: 'ASP-playground-af4a'
  sqlServerResourceGroup: 'cloud-shell-storage-westeurope'
  sqlServerName: 'prenv'  
  sourceDatabaseName: 'mews-develop-db'
  sqlDatabaseName: 'pipeline-created-sqldb-$(System.PullRequest.PullRequestNumber)'
  sqlDatabaseEdition: 'Standard'
  connectionStringName: 'mews-develop-sql-weu/mews-develop-db'  

trigger: none
pr:
- master
pool:
  vmImage: 'windows-latest'

stages:
- stage: Infrastructure_setup
  displayName: Set up the environment
  jobs:
  - job: Create_infrastructure
    displayName: Create the infrastructure
    steps:
    - task: AzurePowerShell@4
      displayName: Create the App Service
      inputs:
        azureSubscription: $(azureSubscription)
        azurePowerShellVersion: latestVersion
        scriptType: filePath
        scriptPath: $(pipelinesDir)\cloneWebApp.ps1
        scriptArguments:
          -location "$(location)" `
          -appServicePlan $(appServicePlan) `
          -resourceGroup $(resourceGroup) `
          -sourceAppName $(appName) `
          -destinationAppName $(destinationAppName)

    - task: AzurePowerShell@4
      displayName: Create SQL Database
      inputs:
        azureSubscription: $(azureSubscription)
        azurePowerShellVersion: latestVersion
        scriptType: filePath
        scriptPath: $(pipelinesDir)\createSqlDatabase.ps1
        scriptArguments:
          -location "$(location)" `
          -resourceGroup $(sqlServerResourceGroup) `
          -serverName $(sqlServerName) `          
          -edition $(sqlDatabaseEdition) `
          -databaseName $(sqlDatabaseName)

    - task: AzurePowerShell@4
      displayName: Update the web app settings
      inputs:
        azureSubscription: $(azureSubscription)
        azurePowerShellVersion: latestVersion
        scriptType: filePath
        scriptPath: $(pipelinesDir)\updateWebAppSettings.ps1
        scriptArguments:
          -resourceGroup $(resourceGroup) `
          -appName $(destinationAppName) `
          -connectionStringName $(connectionStringName) `
          -sourceDatabaseName $(sourceDatabaseName) `
          -databaseName $(sqlDatabaseName)

- template: ./templates/build.yml
  parameters:
    utilsPath: $(utilsPath)
    utilsArtifact: $(utilsArtifact)

- template: ./templates/deploy-without-preview.yml
  parameters:
    azureSubscription: $(azureSubscription)
    environment: $(environment)
    resourceGroup: $(resourceGroup)
    appName: $(destinationAppName)
    productionSlot: $(productionSlot)
    url: 'https://$(destinationAppName).azurewebsites.net'
    utilsArtifact: $(utilsArtifact)
    webRequestAttempts: $(webRequestAttempts)
    webRequestDelayInSeconds: $(webRequestDelayInSeconds)